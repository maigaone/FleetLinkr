<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FleetLinkr - Vehicle Listings</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0074D9">
  <link rel="stylesheet" href="assets/css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/js/mobile-menu.js" defer></script>

  <script>
    // Initialize Supabase
    window.supabase = supabase.createClient(
      "https://dndeljolayctbafmizcl.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRuZGVsam9sYXljdGJhZm1pemNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4NjIxMDUsImV4cCI6MjA2NTQzODEwNX0.OiK-9-BN0NdgSF1ROmEepANA8ZMJ7kMipCpR8xJSA2w"
    );
  </script>
</head>

<body>
  <header class="site-header">
    <div class="header-container">
      <div class="logo-container">
        <img src="assets/images/logo-new.png" alt="FleetLinkr" class="logo-img" width="150" height="60">
        <div class="logo-text">
          <span class="logo-main">FleetLinkr</span>
          <span class="logo-sub">NYC</span>
        </div>
      </div>
    </div>
  </header>

  <nav class="navbar" aria-label="Main navigation">
    <div class="navbar-container">
      <button class="menu-toggle" aria-expanded="false" aria-controls="primary-nav">
        <span class="hamburger">☰</span>
        <span class="close">✕</span>
        <span class="sr-only">Menu</span>
      </button>
      <ul class="navbar-links" id="primary-nav">
        <li><a href="index.html">Home</a></li>
        <li><a href="drivers.html">For Drivers</a></li>
        <li><a href="dealerships.html">For Dealerships</a></li>
        <li><a href="garages.html">For Garages</a></li>
        <li><a href="yellow-garages.html">Yellow Taxi Garages</a></li>
        <li><a href="insurance.html">Insurance</a></li>
        <li><a href="view-listings.html" class="active">Listings</a></li>
        <li><a href="add-listing.html">Add Listing</a></li>
        <li><a href="contact.html">Contact</a></li>
      </ul>
    </div>
  </nav>

  <main class="main-content">
    <section class="listings-controls">
      <div class="search-filter-container">
        <div class="search-box">
          <input type="text" id="search-input" placeholder="Search listings...">
          <button id="search-btn">Search</button>
        </div>
        <div class="filter-controls">
          <select id="filter-make">
            <option value="">All Makes</option>
            <option value="Toyota">Toyota</option>
            <option value="Honda">Honda</option>
            <option value="Nissan">Nissan</option>
            <option value="Hyundai">Hyundai</option>
          </select>
          <input type="number" id="min-price" placeholder="Min price ($)">
          <input type="number" id="max-price" placeholder="Max price ($)">
          <select id="filter-location">
            <option value="">All Locations</option>
            <option value="Manhattan">Manhattan</option>
            <option value="Brooklyn">Brooklyn</option>
            <option value="Queens">Queens</option>
            <option value="Bronx">Bronx</option>
            <option value="Staten Island">Staten Island</option>
          </select>
          <select id="filter-rental-type">
            <option value="">All Rental Types</option>
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
          </select>
          <button id="reset-filters">Reset Filters</button>
        </div>
      </div>
    </section>

    <div id="loading-message" class="loading-state">
      <div class="spinner"></div>
      <p>Loading listings...</p>
    </div>
    
    <div id="error-message" class="error-state hidden">
      <p>Failed to load listings. Please try again later.</p>
      <button id="retry-btn">Retry</button>
    </div>
    
    <div id="no-results-message" class="no-results hidden">
      <p>No listings match your search criteria. Try adjusting your filters.</p>
    </div>

    <div id="listings-container" class="listings-grid"></div>

    <div class="pagination-controls">
      <button id="prev-page" disabled>Previous</button>
      <span id="page-info">Page 1 of 1</span>
      <button id="next-page" disabled>Next</button>
    </div>
  </main>

  <script>
    // URL Helper (for image display only)
    function getImageUrl(filePath) {
      if (!filePath) return '';
      if (/^https?:\/\//i.test(filePath)) return filePath;
      const cleanPath = filePath.trim().replace(/^\/+|\/+$/g, '');
      return cleanPath ? 
        `https://dndeljolayctbafmizcl.supabase.co/storage/v1/object/public/vehicle-images/${cleanPath}` : 
        '';
    }

    // App State
    const state = {
      currentPage: 1,
      itemsPerPage: 6,
      totalPages: 1,
      allListings: [],
      filteredListings: []
    };

    // DOM Elements
    const elements = {
      container: document.getElementById('listings-container'),
      loading: document.getElementById('loading-message'),
      error: document.getElementById('error-message'),
      noResults: document.getElementById('no-results-message'),
      prevPage: document.getElementById('prev-page'),
      nextPage: document.getElementById('next-page'),
      pageInfo: document.getElementById('page-info'),
      searchInput: document.getElementById('search-input'),
      searchBtn: document.getElementById('search-btn'),
      filterMake: document.getElementById('filter-make'),
      filterLocation: document.getElementById('filter-location'),
      filterRentalType: document.getElementById('filter-rental-type'),
      resetFilters: document.getElementById('reset-filters'),
      retryBtn: document.getElementById('retry-btn')
    };

    // Initialize the app
    document.addEventListener('DOMContentLoaded', () => {
      loadListings();
      setupEventListeners();
    });

    // Event Listeners (for viewing only)
    function setupEventListeners() {
      elements.searchBtn.addEventListener('click', applyFilters);
      elements.searchInput.addEventListener('keyup', (e) => e.key === 'Enter' && applyFilters());
      elements.filterMake.addEventListener('change', applyFilters);
      elements.filterLocation.addEventListener('change', applyFilters);
      elements.filterRentalType.addEventListener('change', applyFilters);
      elements.resetFilters.addEventListener('click', resetFilters);
      elements.prevPage.addEventListener('click', goToPreviousPage);
      elements.nextPage.addEventListener('click', goToNextPage);
      elements.retryBtn.addEventListener('click', loadListings);
    }

    // Load listings (read-only)
   async function loadListings() {
  try {
    showLoading();
    const { data, error } = await supabase
      .from('listings') // or your actual table name
      .select('*')
      .order('created_at', { ascending: false });

    if (error) {
      console.error('Supabase error:', error);
      throw error;
    }

    if (!data || data.length === 0) {
      console.warn('No listings found in database');
      state.allListings = [];
      state.filteredListings = [];
      updatePagination();
      return;
    }

    state.allListings = data.map(listing => ({
      ...listing,
      image_urls: listing.photos || []
    }));

    state.filteredListings = [...state.allListings];
    updatePagination();
    renderListings();
  } catch (error) {
    console.error('Error loading listings:', error);
    showError();
  } finally {
    hideLoading();
  }
}

    // Filtering and rendering (view-only)
   function applyFilters() {
  const searchTerm = elements.searchInput.value.toLowerCase();
  const makeFilter = elements.filterMake.value;
  const locationFilter = elements.filterLocation.value;
  const rentalTypeFilter = elements.filterRentalType.value;
  const minPrice = parseFloat(elements.minPrice.value) || 0;
  const maxPrice = parseFloat(elements.maxPrice.value) || Infinity;

  state.filteredListings = state.allListings.filter(listing => {
    const matchesSearch = !searchTerm || 
      (listing.make + ' ' + listing.model + ' ' + listing.description)
        .toLowerCase().includes(searchTerm);
    
    return (
      matchesSearch &&
      (!makeFilter || listing.make === makeFilter) &&
      (!locationFilter || listing.location === locationFilter) &&
      (!rentalTypeFilter || listing.rental_type === rentalTypeFilter) &&
      listing.daily_rate >= minPrice && 
      listing.daily_rate <= maxPrice
    );
  });
  
  state.currentPage = 1;
  updatePagination();
  renderListings();
}

    function resetFilters() {
      elements.searchInput.value = '';
      elements.filterMake.value = '';
      elements.filterLocation.value = '';
      elements.filterRentalType.value = '';
      applyFilters();
    }

    // Pagination
    function goToPreviousPage() {
      if (state.currentPage > 1) {
        state.currentPage--;
        renderListings();
        updatePagination();
      }
    }

    function goToNextPage() {
      if (state.currentPage < state.totalPages) {
        state.currentPage++;
        renderListings();
        updatePagination();
      }
    }

    function updatePagination() {
      state.totalPages = Math.ceil(state.filteredListings.length / state.itemsPerPage);
      elements.pageInfo.textContent = `Page ${state.currentPage} of ${state.totalPages}`;
      elements.prevPage.disabled = state.currentPage === 1;
      elements.nextPage.disabled = state.currentPage === state.totalPages;
      state.filteredListings.length ? hideNoResults() : showNoResults();
    }

    // == Render listings
    function renderListings() {
      const startIdx = (state.currentPage - 1) * state.itemsPerPage;
      const listingsToShow = state.filteredListings.slice(startIdx, startIdx + state.itemsPerPage);
      
      elements.container.innerHTML = listingsToShow.length ? 
        listingsToShow.map(createListingCard).join('') : '';
    }

    function createListingCard(listing) {
  const primaryImage = listing.image_urls?.length ? listing.image_urls[0] : '';
  const priceDisplay = listing.daily_rate ? 
    `$${listing.daily_rate.toLocaleString()}/day` : 
    'Price not specified';

  return `
    <div class="listing-card" data-id="${listing.id}">
      <div class="card-header">
        <h3>${listing.make || ''} ${listing.model || ''} ${listing.year || ''}</h3>
        <span class="price-badge">${priceDisplay}</span>
      </div>
      <div class="images">
        ${primaryImage ? `
          <img src="${primaryImage}" loading="lazy" alt="${listing.make} ${listing.model}" 
               onerror="this.style.display='none'" crossorigin="anonymous">
        ` : '<div class="no-image">No Image Available</div>'}
      </div>
      <div class="listing-details">
        <p><strong>Location:</strong> ${listing.location || 'Not specified'}</p>
        <p><strong>Available From:</strong> ${listing.available_from || 'Not specified'}</p>
        ${listing.weekly_rate ? `<p><strong>Weekly Rate:</strong> $${listing.weekly_rate.toLocaleString()}</p>` : ''}
        ${listing.monthly_rate ? `<p><strong>Monthly Rate:</strong> $${listing.monthly_rate.toLocaleString()}</p>` : ''}
        ${listing.description ? `<p class="details">${listing.description}</p>` : ''}
        <div class="contact-info">
          <button class="contact-btn">Contact Owner</button>
        </div>
      </div>
    </div>
  `;
}

// Quick View Handler
function setupQuickView() {
  document.querySelectorAll('.listing-card').forEach(card => {
    card.addEventListener('click', (e) => {
      // Don't trigger if clicking on contact button
      if (e.target.closest('.contact-btn')) return;
      
      const listingId = card.dataset.id;
      const listing = state.allListings.find(l => l.id === listingId);
      if (listing) showQuickView(listing);
    });
  });
}

// Update renderListings() to call setupQuickView
function renderListings() {
  const startIdx = (state.currentPage - 1) * state.itemsPerPage;
  const listingsToShow = state.filteredListings.slice(startIdx, startIdx + state.itemsPerPage);
  
  elements.container.innerHTML = listingsToShow.length ? 
    listingsToShow.map(createListingCard).join('') : '';
  
  setupQuickView(); // Initialize event listeners
}
    

    // UI State
    function showLoading() {
      elements.loading.style.display = 'flex';
      elements.container.style.display = 'none';
    }

    function hideLoading() {
      elements.loading.style.display = 'none';
      elements.container.style.display = 'grid';
    }

    function showError() {
      elements.error.style.display = 'block';
      elements.container.style.display = 'none';
    }

    function hideError() {
      elements.error.style.display = 'none';
    }

    function showNoResults() {
      elements.noResults.style.display = 'block';
      elements.container.style.display = 'none';
    }

    function hideNoResults() {
      elements.noResults.style.display = 'none';
      elements.container.style.display = 'grid';
    }
  </script>

  <footer>
    <a href="/privacy-policy">Privacy Policy</a> | 
    <a href="/terms-of-service">Terms of Service</a> | 
    <a href="/contact">Contact Us</a>
    <div class="footer-cta">
      <a href="contact.html" class="btn">Get in Touch</a>
    </div>
    <p>📩 <a href="mailto:info@FleetLinkr.com">info@FleetLinkr.com</a></p>
    <p>© 2025 FleetLinkr. All rights reserved.</p>
  </footer>

  <!-- Contact Modal -->
  <div id="contact-modal" class="modal hidden">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h3>Contact Vehicle Owner</h3>
      <form id="contact-form">
        <input type="hidden" id="listing-id">
        <input type="text" id="sender-name" placeholder="Your Name" required>
        <input type="email" id="sender-email" placeholder="Your Email" required>
        <input type="tel" id="sender-phone" placeholder="Your Phone">
        <textarea id="message" placeholder="Your message..." required></textarea>
        <button type="submit">Send Message</button>
      </form>
    </div>
  </div>

<script>
  // Add to your existing <script>
  function showQuickView(listing) {
    const modal = document.getElementById("quick-view-modal");
    document.getElementById("modal-content").innerHTML = `
      <h3>${listing.make} ${listing.model}</h3>
      <p>$${listing.daily_rate}/day</p>
      <p>Location: ${listing.location}</p>
    `;
    modal.classList.remove("hidden");
  }

  // Update createListingCard() to include:
  function createListingCard(listing) {
    return `
      <div class="listing-card" onclick="showQuickView(${JSON.stringify(listing).replace(/"/g, '&quot;')})">
        <!-- ... existing card HTML ... -->
      </div>
    `;
  }
</script>
</body>
</html>