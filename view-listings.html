<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FleetLinkr - Vehicle Listings</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0074D9">
  <link rel="stylesheet" href="assets/css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/js/mobile-menu.js" defer></script>

   <script>
    // Initialize Supabase in head
    window.supabase = supabase.createClient(
      "https://dndeljolayctbafmizcl.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRuZGVsam9sYXljdGJhZm1pemNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4NjIxMDUsImV4cCI6MjA2NTQzODEwNX0.OiK-9-BN0NdgSF1ROmEepANA8ZMJ7kMipCpR8xJSA2w"
    );
  </script>
</head>

<body>
  <header class="site-header">
    <div class="header-container">
      <div class="logo-container">
        <img src="assets/images/logo-new.png" alt="FleetLinkr" class="logo-img" width="150" height="60">
        <div class="logo-text">
          <span class="logo-main">FleetLinkr</span>
          <span class="logo-sub">NYC</span>
        </div>
      </div>
    </div>
  </header>

  <nav class="navbar" aria-label="Main navigation">
    <div class="navbar-container">
      <button class="menu-toggle" aria-expanded="false" aria-controls="primary-nav">
        <span class="hamburger">â˜°</span>
        <span class="close">âœ•</span>
        <span class="sr-only">Menu</span>
      </button>
      <ul class="navbar-links" id="primary-nav">
        <li><a href="index.html">Home</a></li>
        <li><a href="drivers.html">For Drivers</a></li>
        <li><a href="dealerships.html">For Dealerships</a></li>
        <li><a href="garages.html">For Garages</a></li>
        <li><a href="yellow-garages.html">Yellow Taxi Garages</a></li>
        <li><a href="sell-vehicle.html">Sell Vehicle</a></li>
        <li><a href="insurance.html">Insurance</a></li>
        <li><a href="view-listings.html" class="active">Listings</a></li>
        <li><a href="contact.html">Contact</a></li>
      </ul>
    </div>
  </nav>

  <main class="main-content">
    <section class="listings-controls">
      <div class="search-filter-container">
        <div class="search-box">
          <input type="text" id="search-input" placeholder="Search listings...">
          <button id="search-btn">Search</button>
        </div>
        <div class="filter-controls">
          <select id="filter-type">
            <option value="">All Vehicle Types</option>
            <option value="Camry">Toyota Camry</option>
            <option value="Prius">Toyota Prius</option>
            <option value="Highlander">Toyota Highlander</option>
            <option value="Sienna">Toyota Sienna</option>
          </select>
          <select id="filter-location">
            <option value="">All Locations</option>
            <option value="Manhattan">Manhattan</option>
            <option value="Brooklyn">Brooklyn</option>
            <option value="Queens">Queens</option>
            <option value="Bronx">Bronx</option>
            <option value="Staten Island">Staten Island</option>
          </select>
          <select id="filter-rental-type">
            <option value="">All Rental Types</option>
            <option value="Daily">Daily</option>
            <option value="Weekly">Weekly</option>
            <option value="Monthly">Monthly</option>
            <option value="Lease-to-Own">Lease-to-Own</option>
          </select>
          <button id="reset-filters">Reset Filters</button>
        </div>
      </div>
    </section>

    <div id="loading-message" class="loading-state">
      <div class="spinner"></div>
      <p>Loading listings...</p>
    </div>
    
    <div id="error-message" class="error-state hidden">
      <p>Failed to load listings. Please try again later.</p>
      <button id="retry-btn">Retry</button>
    </div>
    
    <div id="no-results-message" class="no-results hidden">
      <p>No listings match your search criteria. Try adjusting your filters.</p>
    </div>

    <div id="listings-container" class="listings-grid"></div>

    <div class="pagination-controls">
      <button id="prev-page" disabled>Previous</button>
      <span id="page-info">Page 1 of 1</span>
      <button id="next-page" disabled>Next</button>
    </div>
  </main>

  
    // ðŸ†• --- tiny helper that ALWAYS returns a valid URL ---
<script>
/* ---------- Supabase helper ----------- */
function getImageUrl(filePath) {
  // Already absolute? return as-is
  if (/^https?:\/\//i.test(filePath)) return filePath;

  // Ask Supabase for the public URL
  const { data } = supabase
    .storage
    .from('vehicle-images')
    .getPublicUrl(filePath.trim());

  return data?.publicUrl || '';
}

/* ------------ App State --------------- */
const state = {
  currentPage: 1,
  itemsPerPage: 6,
  totalPages: 1,
  allListings: [],
  filteredListings: []
};

/* ------------ DOM Refs ---------------- */
const el = id => document.getElementById(id);
const elements = {
  container: el('listings-container'),
  loading:   el('loading-message'),
  error:     el('error-message'),
  noResults: el('no-results-message'),
  prevPage:  el('prev-page'),
  nextPage:  el('next-page'),
  pageInfo:  el('page-info'),
  searchInput: el('search-input'),
  searchBtn:   el('search-btn'),
  filterType:      el('filter-type'),
  filterLocation:  el('filter-location'),
  filterRentalType:el('filter-rental-type'),
  resetFilters:    el('reset-filters'),
  retryBtn:        el('retry-btn')
};

/* ------------ Init -------------------- */
document.addEventListener('DOMContentLoaded', () => {
  loadListings();
  setupEventListeners();
});

/* ------------ Events ------------------ */
function setupEventListeners() {
  elements.searchBtn.addEventListener('click', applyFilters);
  elements.searchInput.addEventListener('keyup', e => e.key === 'Enter' && applyFilters());
  elements.filterType.addEventListener('change', applyFilters);
  elements.filterLocation.addEventListener('change', applyFilters);
  elements.filterRentalType.addEventListener('change', applyFilters);
  elements.resetFilters.addEventListener('click', resetFilters);
  elements.prevPage.addEventListener('click', goToPreviousPage);
  elements.nextPage.addEventListener('click', goToNextPage);
  elements.retryBtn.addEventListener('click', loadListings);
}

/* ------------ Data Load --------------- */
async function loadListings() {
  try {
    showLoading();
    hideError(); hideNoResults();

    const { data, error } = await supabase
      .from('listings')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) throw error;

    state.allListings = (data || []).map(l => {
      /* --- robust image_urls parser --- */
      let urls = [];
      try {
        if (Array.isArray(l.image_urls))       urls = l.image_urls;
        else if (typeof l.image_urls === 'string') {
          const str = l.image_urls.trim();
          if (str.startsWith('['))  urls = JSON.parse(str);
          else                      urls = str.split(',').map(u=>u.trim());
        }
      } catch (e) {
        console.warn('parse error for listing', l.id, e);
      }

      console.log('Listing', l.id, 'parsed URLs:', urls);
      l.image_urls = urls.map(getImageUrl).filter(Boolean);
      return l;
    });

    state.filteredListings = [...state.allListings];
    state.totalPages = Math.max(1, Math.ceil(state.filteredListings.length / state.itemsPerPage));

    state.allListings.length ? renderListings() : showNoResults();
    updatePagination();
  } catch (err) {
    console.error(err); showError();
  } finally {
    hideLoading();
  }
}

/* ------------ Filters ----------------- */
function applyFilters() {
  try {
    const q       = elements.searchInput.value.toLowerCase();
    const type    = elements.filterType.value;
    const loc     = elements.filterLocation.value;
    const rentype = elements.filterRentalType.value;

    state.filteredListings = state.allListings.filter(l => {
      const matchSearch = (l.vehicle_type||'').toLowerCase().includes(q) ||
                          (l.tlc_plate||'').toLowerCase().includes(q)     ||
                          (l.additional_details||'').toLowerCase().includes(q);
      const matchType   = type ? l.vehicle_type === type : true;
      const matchLoc    = loc  ? l.location     === loc  : true;
      const matchRent   = rentype ? l.rental_type === rentype : true;
      return matchSearch && matchType && matchLoc && matchRent;
    });

    state.currentPage = 1;
    state.totalPages  = Math.max(1, Math.ceil(state.filteredListings.length / state.itemsPerPage));
    state.filteredListings.length ? (hideNoResults(), renderListings()) : showNoResults();
    updatePagination();
  } catch (err) {
    console.error(err); showError();
  }
}
function resetFilters() { elements.searchInput.value=''; elements.filterType.value=''; elements.filterLocation.value=''; elements.filterRentalType.value=''; applyFilters(); }

/* ------------ Pagination -------------- */
function goToPreviousPage(){ if (state.currentPage>1){ state.currentPage--; renderListings(); updatePagination(); } }
function goToNextPage(){ if (state.currentPage<state.totalPages){ state.currentPage++; renderListings(); updatePagination(); } }
function updatePagination(){
  elements.pageInfo.textContent = `Page ${state.currentPage} of ${state.totalPages}`;
  elements.prevPage.disabled = state.currentPage===1;
  elements.nextPage.disabled = state.currentPage===state.totalPages;
}

/* ------------ Render ------------------ */
function renderListings() {
  const start = (state.currentPage-1)*state.itemsPerPage;
  const page  = state.filteredListings.slice(start, start+state.itemsPerPage);

  elements.container.innerHTML='';
  if (!page.length){ showNoResults(); return; }

  const frag=document.createDocumentFragment();
  page.forEach(l=>frag.appendChild(createListingCard(l)));
  elements.container.appendChild(frag);
}
function createListingCard(l){
  const card=document.createElement('div');
  card.className='listing-card';

  const imgs = l.image_urls.length
      ? l.image_urls.map(u=>`<img src="${u}" alt="${l.vehicle_type}" loading="lazy" onerror="this.style.display='none'>`).join('')
      : '<div class="no-image">No Image Available</div>';

  const price = l.price_per_day ? `$${l.price_per_day.toLocaleString()}/day` : 'Price not specified';
  card.innerHTML = `
    <div class="card-header">
      <h3>${l.vehicle_type||'Vehicle'}</h3>
      <p class="tlc-plate">${l.tlc_plate||'TLC Plate Not Provided'}</p>
      <span class="price-badge">${price}</span>
    </div>
    <div class="images">${imgs}</div>
    <div class="listing-details">
      <p><strong>Location:</strong> ${l.location||'Not specified'}</p>
      <p><strong>Rental Type:</strong> ${l.rental_type||'Not specified'}</p>
      ${l.additional_details?`<p class="details">${l.additional_details}</p>`:''}
      <div class="contact-info">
        <p><strong>Contact:</strong> ${l.owner_name||'Name not provided'}</p>
        ${l.phone?`<p><strong>Phone:</strong> <span class="phone-number">${formatPhoneNumber(l.phone)}</span></p>`:''}
        <button class="contact-btn" data-id="${l.id}">Contact Owner</button>
      </div>
    </div>`;
  card.querySelector('.contact-btn').addEventListener('click',()=>alert(`Contact form for ${l.vehicle_type}`));
  return card;
}

/* ------------ Helpers ----------------- */
function formatPhoneNumber(p){ if(!p)return ''; const c=(''+p).replace(/\D/g,''); const m=c.match(/^(\d{3})(\d{3})(\d{4})$/); return m?`(${m[1]}) ${m[2]}-${m[3]}`:p; }

/* ------------ UI Toggles -------------- */
function showLoading(){ elements.loading.style.display='flex'; elements.container.style.display='none'; }
function hideLoading(){ elements.loading.style.display='none'; elements.container.style.display='grid'; }
function showError(){ elements.error.style.display='block'; elements.container.style.display='none'; }
function hideError(){ elements.error.style.display='none'; }
function showNoResults(){ elements.noResults.style.display='block'; elements.container.style.display='none'; }
function hideNoResults(){ elements.noResults.style.display='none'; elements.container.style.display='grid'; }


  </script>

  <!-- Contact Modal -->
  <div id="contact-modal" class="modal hidden">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h3>Contact Vehicle Owner</h3>
      <form id="contact-form">
        <input type="hidden" id="listing-id">
        <input type="text" id="sender-name" placeholder="Your Name" required>
        <input type="email" id="sender-email" placeholder="Your Email" required>
        <input type="tel" id="sender-phone" placeholder="Your Phone">
        <textarea id="message" placeholder="Your message..." required></textarea>
        <button type="submit">Send Message</button>
      </form>
    </div>
  </div>
</body>
</html>