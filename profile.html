<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FleetLinkr – Your Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      margin: 0;
      background: #f5f7fb;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .profile-container {
      background: #ffffff;
      padding: 2.5rem 3rem;
      border-radius: 16px;
      max-width: 480px;
      width: 100%;
      box-shadow: 0 12px 40px rgba(0,0,0,0.08);
      position: relative;
      overflow: hidden;
    }

    .profile-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid #e5e7eb;
    }

    .profile-header h2 {
      margin: 0;
      font-size: 1.75rem;
      color: #111827;
      font-weight: 700;
    }

    .profile-actions {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
    }

    .btn-edit {
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #d1d5db;
    }

    .btn-edit:hover {
      background: #e5e7eb;
    }

    .btn-save {
      background: #2563eb;
      color: white;
    }

    .btn-save:hover {
      background: #1d4ed8;
    }

    .btn-cancel {
      background: #fef2f2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    .btn-cancel:hover {
      background: #fee2e2;
    }

    .btn-logout {
      background: transparent;
      color: #6b7280;
      border: 1px solid #d1d5db;
    }

    .btn-logout:hover {
      background: #f9fafb;
    }

    .profile-subtitle {
      font-size: 0.95rem;
      color: #6b7280;
      text-align: center;
      margin-bottom: 2rem;
      line-height: 1.5;
    }

    /* Profile Info Display (View Mode) */
    .profile-info {
      margin-bottom: 2rem;
    }

    .info-group {
      margin-bottom: 1.5rem;
      padding: 1.2rem;
      background: #f9fafb;
      border-radius: 10px;
      border-left: 4px solid #2563eb;
    }

    .info-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 0.4rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .info-value {
      font-size: 1.1rem;
      color: #111827;
      font-weight: 500;
    }

    /* Profile Form (Edit Mode) */
    .profile-form {
      margin-bottom: 2rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #374151;
    }

    .form-group input {
      width: 100%;
      padding: 0.8rem 1rem;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 1rem;
      box-sizing: border-box;
      transition: border 0.2s ease;
    }

    .form-group input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
    }

    .form-group input:disabled {
      background: #f3f4f6;
      color: #6b7280;
      cursor: not-allowed;
    }

    /* Messages */
    .profile-message {
      margin: 1.5rem 0;
      padding: 1rem;
      border-radius: 8px;
      font-size: 0.9rem;
      text-align: center;
      display: none;
    }

    .profile-message.error {
      background: #fef2f2;
      color: #991b1b;
      border: 1px solid #fecaca;
      display: block;
    }

    .profile-message.success {
      background: #f0fdf4;
      color: #065f46;
      border: 1px solid #bbf7d0;
      display: block;
    }

    /* Footer */
    .profile-footer {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid #e5e7eb;
      text-align: center;
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .profile-footer a {
      color: #2563eb;
      text-decoration: none;
      font-weight: 500;
    }

    .profile-footer a:hover {
      text-decoration: underline;
    }

    /* Responsive */
    @media (max-width: 600px) {
      .profile-container {
        padding: 2rem 1.5rem;
        margin: 1rem;
      }
      
      .profile-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }
      
      .profile-actions {
        width: 100%;
        justify-content: space-between;
      }
    }

    /* Animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .profile-container {
      animation: fadeIn 0.3s ease-out;
    }
  </style>
</head>
<body>

<div class="profile-container">
  <!-- Header -->
  <div class="profile-header">
    <h2>Your Profile</h2>
    <div class="profile-actions" id="profile-actions">
      <button class="btn btn-edit" id="edit-btn">Edit Profile</button>
      <button class="btn btn-logout" id="logout-btn">Logout</button>
    </div>
  </div>

  <p class="profile-subtitle">
    Keep your contact details up to date for your listings and communications.
  </p>

  <!-- Profile Info Display (View Mode) -->
  <div class="profile-info" id="profile-info">
    <div class="info-group">
      <div class="info-label">Email Address</div>
      <div class="info-value" id="display-email">Loading...</div>
    </div>
    
    <div class="info-group">
      <div class="info-label">Full Name</div>
      <div class="info-value" id="display-name">Loading...</div>
    </div>
    
    <div class="info-group">
      <div class="info-label">Phone Number</div>
      <div class="info-value" id="display-phone">Loading...</div>
    </div>

    <div class="info-group">
      <div class="info-label">Account Created</div>
      <div class="info-value" id="display-created">Loading...</div>
    </div>
  </div>

  <!-- Profile Form (Edit Mode - Initially Hidden) -->
  <form class="profile-form" id="profile-form" style="display: none;">
    <div class="form-group">
      <label>Email Address</label>
      <input type="email" id="profile-email" disabled />
      <small style="color: #6b7280; font-size: 0.85rem;">Email cannot be changed</small>
    </div>

    <div class="form-group">
      <label>Full Name</label>
      <input type="text" id="profile-name" required />
    </div>

    <div class="form-group">
      <label>Phone Number</label>
      <input type="tel" id="profile-phone" required />
    </div>

    <div class="profile-actions">
      <button type="submit" class="btn btn-save" id="save-btn">Save Changes</button>
      <button type="button" class="btn btn-cancel" id="cancel-btn">Cancel</button>
      <button class="auth-btn logout-btn" id="logout-btn">Logout</button>
    </div>
  </form>

  <!-- Messages -->
  <div class="profile-message" id="profile-message"></div>

  <!-- Footer -->
  <div class="profile-footer">
    <p>
      Need help? <a href="contact.html">Contact Support</a> • 
      <a href="index.html">Back to Home</a>
    </p>
  </div>
</div>

<script>
  // Use the global supabase instance
const supabase = window.supabase;

// If supabase doesn't exist, create it
if (!supabase) {
    const supabaseUrl = "https://klredsqvkblbhooinwwz.supabase.co";
    const supabaseAnonKey = "sb_publishable_CHt4q1TQCEZXs-v62TCaxA_3vj3C6J9";
    
    window.supabase = supabase.createClient(supabaseUrl, supabaseAnonKey, {
        auth: { persistSession: true }
    });
}

  document.addEventListener("DOMContentLoaded", async () => {
    // DOM Elements
    const profileInfo = document.getElementById("profile-info");
    const profileForm = document.getElementById("profile-form");
    const editBtn = document.getElementById("edit-btn");
    const cancelBtn = document.getElementById("cancel-btn");
    const saveBtn = document.getElementById("save-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const messageEl = document.getElementById("profile-message");

    // Display elements
    const displayEmail = document.getElementById("display-email");
    const displayName = document.getElementById("display-name");
    const displayPhone = document.getElementById("display-phone");
    const displayCreated = document.getElementById("display-created");

    // Form elements
    const profileEmail = document.getElementById("profile-email");
    const profileName = document.getElementById("profile-name");
    const profilePhone = document.getElementById("profile-phone");

    let currentProfile = null;

    // Check authentication
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      window.location.href = "login.html";
      return;
    }

    // Load profile data
    async function loadProfile() {
      const { data: profile, error } = await supabase
        .from("user_profiles")
        .select("*")
        .eq("user_id", user.id)
        .single();

      if (error) {
        showMessage("Error loading profile: " + error.message, "error");
        return;
      }

      currentProfile = profile || {
        email: user.email,
        full_name: "",
        phone: "",
        created_at: new Date().toISOString()
      };

      // Update display
      displayEmail.textContent = currentProfile.email || user.email || "Not set";
      displayName.textContent = currentProfile.full_name || "Not set";
      displayPhone.textContent = currentProfile.phone || "Not set";
      
      if (currentProfile.created_at) {
        const date = new Date(currentProfile.created_at);
        displayCreated.textContent = date.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      }

      // Update form
      profileEmail.value = currentProfile.email || user.email || "";
      profileName.value = currentProfile.full_name || "";
      profilePhone.value = currentProfile.phone || "";
    }

    // Toggle between view and edit modes
    function toggleEditMode(isEditing) {
      profileInfo.style.display = isEditing ? "none" : "block";
      profileForm.style.display = isEditing ? "block" : "none";
      editBtn.textContent = isEditing ? "View Profile" : "Edit Profile";
    }

    // Show message
    function showMessage(text, type) {
      messageEl.textContent = text;
      messageEl.className = "profile-message " + type;
      messageEl.style.display = "block";
      
      if (type === "success") {
        setTimeout(() => {
          messageEl.style.display = "none";
        }, 3000);
      }
    }

    // Event Listeners
    editBtn.addEventListener("click", () => {
      const isEditing = profileForm.style.display === "block";
      toggleEditMode(!isEditing);
      messageEl.style.display = "none";
    });

    cancelBtn.addEventListener("click", () => {
      toggleEditMode(false);
      // Reset form to current values
      profileName.value = currentProfile.full_name || "";
      profilePhone.value = currentProfile.phone || "";
      messageEl.style.display = "none";
    });

    logoutBtn.addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = "login.html";
    });

    profileForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const fullName = profileName.value.trim();
      const phone = profilePhone.value.trim();

      if (!fullName || !phone) {
        showMessage("Please fill in all required fields", "error");
        return;
      }

      saveBtn.disabled = true;
      saveBtn.textContent = "Saving...";

      const updates = {
        user_id: user.id,
        email: user.email,
        full_name: fullName,
        phone: phone,
        updated_at: new Date().toISOString()
      };

      const { error } = await supabase
        .from("user_profiles")
        .upsert(updates);

      if (error) {
        showMessage("Error: " + error.message, "error");
        saveBtn.disabled = false;
        saveBtn.textContent = "Save Changes";
        return;
      }

      showMessage("Profile updated successfully!", "success");
      saveBtn.disabled = false;
      saveBtn.textContent = "Save Changes";
      
      // Reload profile data
      await loadProfile();
      
      // Switch back to view mode after 1 second
      setTimeout(() => {
        toggleEditMode(false);
      }, 1000);
    });

    // Initial load
    await loadProfile();
  });
</script>
</body>
</html>

