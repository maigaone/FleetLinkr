<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FleetLinkr - Add Listing</title>
  <link rel="stylesheet" href="assets/css/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>

  <style>
    .add-listing-container { max-width: 800px; margin: 2rem auto; padding: 2rem; background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .add-listing-form { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    .form-group { margin-bottom: 1rem; }
    .form-group.full-width { grid-column: span 2; }
    label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333; }
    input, textarea, select { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; }
    textarea { min-height: 120px; resize: vertical; }
    .file-upload { border: 2px dashed #ddd; padding: 2rem; text-align: center; border-radius: 4px; cursor: pointer; }
    .file-upload:hover { border-color: #0074D9; }
    .submit-btn { grid-column: span 2; background: #0074D9; color: white; padding: 1rem; border: none; border-radius: 4px; font-size: 1.1rem; cursor: pointer; transition: background 0.3s; }
    .submit-btn:hover { background: #005ea6; }
    h1 { color: #0074D9; margin-bottom: 2rem; text-align: center; }
    .g-recaptcha { grid-column: span 2; margin: 1rem 0; display: flex; justify-content: center; }
    .auth-section,.signup-section { text-align: center; padding: 1rem; background: #f8f9fa; margin-bottom: 1rem; }
    .auth-btn { background: #0074D9; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; margin: 0.5rem; }
    .auth-btn:hover { background: #005ea6; }
    #profile-modal { text-align: center; background: #f1f1f1; padding: 1rem; margin: 1rem auto; width: 80%; border-radius: 8px; }
    .hidden { display: none; }
  </style>
</head>

<body>

  <!-- Auth Section -->
  <div class="signup-section" id="signup-section">
    <h2>Create an Account</h2>
    <input type="email" id="signup-email" placeholder="Email" required />
    <input type="password" id="signup-password" placeholder="Password" required />
    <button class="auth-btn" id="signup-btn">Sign Up</button>

    <h2>or Login</h2>
    <input type="email" id="login-email" placeholder="Email" required />
    <input type="password" id="login-password" placeholder="Password" required />
    <button class="auth-btn" id="login-btn">Login</button>

    <button class="auth-btn" id="logout-btn" style="display:none;">Logout</button>
    <p id="auth-message"></p>
  </div>

  <!-- Profile Completion Modal -->
  <div id="profile-modal" class="hidden">
    <h3>Complete Your Profile</h3>
    <input type="email" id="profile-email" placeholder="Email" readonly />
    <input type="text" id="profile-name" placeholder="Full Name" required />
    <input type="tel" id="profile-phone" placeholder="Phone" required />
    <button class="auth-btn" id="save-profile-btn">Save</button>
  </div>

  <!-- Add Listing Form -->
  <form id="add-listing-form" class="hidden" enctype="multipart/form-data">
    <h2>Add a Rental Listing</h2>

    <input type="text" id="make" placeholder="Make" required />
    <input type="text" id="model" placeholder="Model" required />
    <input type="number" id="year" placeholder="Year" min="2000" max="2026" required />
    <input type="number" id="daily-rate" placeholder="Daily Rate $" min="1" step="0.01" required />
    <input type="number" id="weekly-rate" placeholder="Weekly Rate $" step="0.01" />
    <input type="number" id="monthly-rate" placeholder="Monthly Rate $" step="0.01" />
    <input type="number" id="minimum-rental-days" placeholder="Minimum Rental Days" min="1" required />
    <input type="date" id="available-from" required />
    <input type="date" id="available-to" />
    <input type="number" id="included-mileage" placeholder="Included Mileage" />
    <input type="number" id="excess-mileage-fee" placeholder="Excess Mileage Fee" step="0.01" />
    <input type="text" id="location" placeholder="Location" required />

    <label for="tlc-inspection">TLC Inspection</label>
    <select id="tlc-inspection" required>
      <option value="">Select...</option>
      <option value="true">Valid</option>
      <option value="false">Expired</option>
    </select>

    <textarea id="description" placeholder="Additional Details..."></textarea>
    <select id="contact-method">
      <option value="profile">Use Profile Contact</option>
      <option value="custom">Custom Contact Info</option>
    </select>

    <input type="file" id="image-upload" accept="image/*" multiple required />

    <div id="image-previews" style="display:flex; gap:10px; margin:10px 0;"></div>
    <div class="g-recaptcha" data-sitekey="6LeRrGwrAAAAAHOf1H2c-iWsTfzwTbGkgF6qifXY"></div>

    <button class="submit-btn" type="submit">Submit Listing</button>
  </form>




<script>
document.addEventListener("DOMContentLoaded", async () => {

  // Initialize Supabase
  const supabase = window.supabase.createClient(
    "https://klredsqvkblbhooinwwz.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtscmVkc3F2a2JsYmhvb2lud3d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5MjIzMzEsImV4cCI6MjA3OTQ5ODMzMX0.b8TLcQcA-5YyNo1jcL0L7bov29Q_0ocQXlqCU1ocOk8"
  );

  const signupSection = document.getElementById("signup-section");
  const profileModal = document.getElementById("profile-modal");
  const listingForm = document.getElementById("add-listing-form");
  const logoutBtn = document.getElementById("logout-btn");

  function toggle(view, show) {
    view.classList.toggle("hidden", !show);
  }

  // Check session
  async function loadUI() {
    const { data: { session } } = await supabase.auth.getSession();

    if (!session) {
      toggle(signupSection, true);
      return;
    }

    const user = session.user;
    toggle(signupSection, false);
    toggle(logoutBtn, true);
    document.getElementById("auth-message").textContent = `Welcome, ${user.email}`;

    // Load profile
    const { data: profile } = await supabase
      .from("user_profiles")
      .select("*")
      .eq("user_id", user.id)
      .single();

    // Require full_name + phone
    if (!profile?.full_name || !profile?.phone) {
      toggle(profileModal, true);
      document.getElementById("profile-email").value = user.email;
    } else {
      toggle(listingForm, true);
    }
  }

  // Signup
  document.getElementById("signup-btn").addEventListener("click", async () => {
    const email = document.getElementById("signup-email").value;
    const password = document.getElementById("signup-password").value;

    const { error } = await supabase.auth.signUp({ email, password });
    if (error) return alert(error.message);

    alert("Signup successful! Check your email to confirm.");
  });

  // Login
  document.getElementById("login-btn").addEventListener("click", async () => {
    const email = document.getElementById("login-email").value;
    const password = document.getElementById("login-password").value;

    const { data, error } = await supabase.auth.signInWithPassword({ email, password });

    if (error) return alert(error.message);

    // Update last login
    await supabase
      .from("user_profiles")
      .update({ last_login: new Date().toISOString() })
      .eq("user_id", data.user.id);

    location.reload();
  });

  // Save profile
  document.getElementById("save-profile-btn").addEventListener("click", async () => {
    const fullName = document.getElementById("profile-name").value;
    const phone = document.getElementById("profile-phone").value;
    const email = document.getElementById("profile-email").value;

    const { data: { user } } = await supabase.auth.getUser();

    const { error } = await supabase
      .from("user_profiles")
      .upsert({
        user_id: user.id,
        email,
        full_name: fullName,
        phone,
        updated_at: new Date().toISOString()
      });

    if (error) return alert(error.message);

    toggle(profileModal, false);
    toggle(listingForm, true);
  });

  // Logout
  logoutBtn.addEventListener("click", async () => {
    await supabase.auth.signOut();
    location.reload();
  });

  // Image previews
  document.getElementById("image-upload").addEventListener("change", (e) => {
    const preview = document.getElementById("image-previews");
    preview.innerHTML = "";
    Array.from(e.target.files).forEach(file => {
      const img = document.createElement("img");
      img.src = URL.createObjectURL(file);
      img.style.height = "60px";
      preview.appendChild(img);
    });
  });

  // Listing submission
  document.getElementById("add-listing-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    // Validate recaptcha
    const cap = grecaptcha.getResponse();
    if (!cap) return alert("Please complete reCAPTCHA.");

    const files = document.getElementById("image-upload").files;
    if (files.length === 0) return alert("Please upload images.");

    const { data: { user } } = await supabase.auth.getUser();

    // Upload images
    const urls = [];
    for (const file of files) {
      const path = `listings/${user.id}/${Date.now()}-${file.name}`;
      const { error: uploadError } = await supabase.storage
        .from("vehicle-images")
        .upload(path, file);

      if (uploadError) return alert(uploadError.message);

      urls.push(
        supabase.storage
          .from("vehicle-images")
          .getPublicUrl(path).data.publicUrl
      );
    }

    // Prepare listing
    const listing = {
      owner_id: user.id,
      make: document.getElementById("make").value,
      model: document.getElementById("model").value,
      year: parseInt(document.getElementById("year").value),
      daily_rate: parseFloat(document.getElementById("daily-rate").value),
      weekly_rate: parseFloat(document.getElementById("weekly-rate").value) || null,
      monthly_rate: parseFloat(document.getElementById("monthly-rate").value) || null,
      minimum_rental_days: parseInt(document.getElementById("minimum-rental-days").value),
      available_from: document.getElementById("available-from").value,
      available_to: document.getElementById("available-to").value || null,
      included_mileage: parseInt(document.getElementById("included-mileage").value) || 100,
      excess_mileage_fee: parseFloat(document.getElementById("excess-mileage-fee").value) || 0.5,
      location: document.getElementById("location").value,
      tlc_inspection: document.getElementById("tlc-inspection").value === "true",
      description: document.getElementById("description").value,
      contact_method: document.getElementById("contact-method").value,
      photos: urls,
      status: "active",
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    };

    const { error } = await supabase
      .from("rental_listings")
      .insert(listing);

    if (error) return alert(error.message);

    alert("Listing submitted!");
    window.location.href = "thank-you.html";
  });

  await loadUI();

});
</script>

</body>
</html>




