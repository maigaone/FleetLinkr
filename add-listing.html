<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FleetLinkr - Add New Listing</title>
  <link rel="stylesheet" href="assets/css/styles.css">
  <style>
    /* Add these styles to your existing styles.css or keep them here */
    .add-listing-container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 2rem;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .add-listing-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-group.full-width {
      grid-column: span 2;
    }
    
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #333;
    }
    
    input, textarea, select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
    }
    
    textarea {
      min-height: 120px;
      resize: vertical;
    }
    
    .file-upload {
      border: 2px dashed #ddd;
      padding: 2rem;
      text-align: center;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .file-upload:hover {
      border-color: #0074D9;
    }
    
    .submit-btn {
      grid-column: span 2;
      background: #0074D9;
      color: white;
      padding: 1rem;
      border: none;
      border-radius: 4px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .submit-btn:hover {
      background: #005ea6;
    }
    
    h1 {
      color: #0074D9;
      margin-bottom: 2rem;
      text-align: center;
    }

    .g-recaptcha {
      grid-column: span 2;
      margin: 1rem 0;
      display: flex;
      justify-content: center;
    }

    .error-message {
      color: #d9534f;
      font-size: 0.9rem;
      margin-top: 0.25rem;
      display: none;
    }

    .auth-section {
      text-align: center;
      padding: 1rem;
      background: #f8f9fa;
      margin-bottom: 1rem;
    }

    .auth-btn {
      background: #0074D9;
      color: white;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 0 0.5rem;
    }

    .auth-btn:hover {
      background: #005ea6;
    }
  </style>

  <!-- Load Supabase first -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>

</head>

<body>

  <script>
  // Initialize Supabase as soon as the script loads
  const SUPABASE_URL = "https://dndeljolayctbafmizcl.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRuZGVsam9sYXljdGJhZm1pemNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4NjIxMDUsImV4cCI6MjA2NTQzODEwNX0.OiK-9-BN0NdgSF1ROmEepANA8ZMJ7kMipCpR8xJSA2w";
  
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
    auth: {
      flowType: 'pkce',
      autoRefreshToken: true,
      persistSession: true,
      detectSessionInUrl: true
    }
  });

  document.addEventListener('DOMContentLoaded', async () => {
    try {
      // Check auth state using the initialized supabase client
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();
      if (sessionError) throw sessionError;
      
      if (session?.user) {
        updateUIForLoggedInUser(session.user);
      }

      // Login handler
      document.getElementById('login-btn').addEventListener('click', async () => {
        try {
          const { error } = await supabase.auth.signInWithOAuth({
            provider: 'google',
            options: {
              redirectTo: window.location.href,
              queryParams: {
                access_type: 'offline',
                prompt: 'consent'
              }
            }
          });
          if (error) throw error;
        } catch (error) {
          console.error("Login error:", error);
          alert("Login failed. Please try again.");
        }
      });

      // Logout handler
      document.getElementById('logout-btn').addEventListener('click', async () => {
        try {
          const { error } = await supabase.auth.signOut();
          if (error) throw error;
          window.location.reload();
        } catch (error) {
          console.error("Logout error:", error);
          alert("Logout failed: " + error.message);
        }
      });

      // Helper function to update UI
      function updateUIForLoggedInUser(user) {
        document.getElementById('auth-message').textContent = `Welcome, ${user.email || 'user'}`;
        document.getElementById('login-btn').style.display = 'none';
        document.getElementById('logout-btn').style.display = 'block';
        document.getElementById('add-listing-form').style.display = 'grid';
      }

      // Image Upload Handler
      async function uploadImage(file) {
        const fileName = `rentals/${Date.now()}-${file.name.replace(/\s+/g, '-')}`;
        const { data, error } = await supabase.storage
          .from('vehicle-images')
          .upload(fileName, file);
        
        if (error) throw error;
        return `${SUPABASE_URL}/storage/v1/object/public/vehicle-images/${fileName}`;
      }

      // Form Validation
      function validateForm() {
        let isValid = true;
        const requiredFields = [
          'make', 'model', 'year', 'tlc-plate', 'daily-rate', 
          'minimum-days', 'available-from', 'location'
        ];

        requiredFields.forEach(fieldId => {
          const element = document.getElementById(fieldId);
          const errorElement = document.getElementById(`${fieldId}-error`);
          
          if (!element.value) {
            errorElement.style.display = 'block';
            isValid = false;
          } else {
            errorElement.style.display = 'none';
          }
        });

        const year = parseInt(document.getElementById('year').value);
        if (year < 2000 || year > 2025) {
          document.getElementById('year-error').style.display = 'block';
          isValid = false;
        }

        const files = document.getElementById('image-upload').files;
        if (files.length === 0) {
          document.getElementById('image-upload-error').style.display = 'block';
          isValid = false;
        } else if (files.length > 10) {
          document.getElementById('image-upload-error').textContent = 'Maximum 10 photos allowed';
          document.getElementById('image-upload-error').style.display = 'block';
          isValid = false;
        }

        if (!document.getElementById('tlc_inspection').checked) {
          document.getElementById('tlc-inspection-error').style.display = 'block';
          isValid = false;
        }

        const recaptchaResponse = grecaptcha.getResponse();
        if (!recaptchaResponse) {
          document.getElementById('recaptcha-error').style.display = 'block';
          isValid = false;
        }

        return isValid;
      }

      // Form Submission
      document.getElementById('add-listing-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!validateForm()) return;

        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Processing...';
        
        try {
          // Upload images
          const files = document.getElementById('image-upload').files;
          const imageUrls = await Promise.all(
            Array.from(files).map(file => uploadImage(file))
          );

          // Get current user
          const { data: { user }, error: userError } = await supabase.auth.getUser();
          if (userError || !user) throw new Error("User not authenticated");

          // Prepare listing data
          const listingData = {
            make: document.getElementById('make').value,
            model: document.getElementById('model').value,
            year: parseInt(document.getElementById('year').value),
            tlc_plate: document.getElementById('tlc-plate').value,
            daily_rate: Math.round(parseFloat(document.getElementById('daily-rate').value) * 100),
            weekly_rate: Math.round(parseFloat(document.getElementById('weekly-rate').value || 
              document.getElementById('daily-rate').value * 5) * 100),
            monthly_rate: Math.round(parseFloat(document.getElementById('monthly-rate').value || 
              document.getElementById('daily-rate').value * 20) * 100),
            minimum_rental_days: parseInt(document.getElementById('minimum-days').value),
            available_from: document.getElementById('available-from').value,
            available_to: document.getElementById('available-to').value || null,
            included_mileage: parseInt(document.getElementById('included-mileage').value),
            excess_mileage_fee: Math.round(parseFloat(document.getElementById('excess-fee').value )* 100),
            location: document.getElementById('location').value,
            photos: imageUrls,
            tlc_inspection: document.getElementById('tlc_inspection').checked,
            status: 'active',
            user_id: user.id,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
          };

          // Insert listing
          const { error } = await supabase.from('rental_listings').insert([listingData]);
          if (error) throw error;
          
          window.location.href = "thank-you.html";
        } catch (error) {
          console.error("Error:", error);
          alert("Failed to add listing: " + error.message);
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Listing';
          grecaptcha.reset();
        }
      });

    } catch (error) {
      console.error("Initialization error:", error);
      alert("Application initialization failed. Please refresh the page.");
    }
  });


 </script>
 
</body>
</html>
