<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FleetLinkr - Add Listing</title>
  <link rel="stylesheet" href="assets/css/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <style>
    .add-listing-container { max-width: 800px; margin: 2rem auto; padding: 2rem; background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .add-listing-form { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    .form-group { margin-bottom: 1rem; }
    .form-group.full-width { grid-column: span 2; }
    label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333; }
    input, textarea, select { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; }
    textarea { min-height: 120px; resize: vertical; }
    .file-upload { border: 2px dashed #ddd; padding: 2rem; text-align: center; border-radius: 4px; cursor: pointer; }
    .file-upload:hover { border-color: #0074D9; }
    .submit-btn { grid-column: span 2; background: #0074D9; color: white; padding: 1rem; border: none; border-radius: 4px; font-size: 1.1rem; cursor: pointer; transition: background 0.3s; }
    .submit-btn:hover { background: #005ea6; }
    h1 { color: #0074D9; margin-bottom: 2rem; text-align: center; }
    .g-recaptcha { grid-column: span 2; margin: 1rem 0; display: flex; justify-content: center; }
    .auth-section, .signup-section { text-align: center; padding: 1rem; background: #f8f9fa; margin-bottom: 1rem; }
    .auth-btn { background: #0074D9; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; margin: 0.5rem; }
    .auth-btn:hover { background: #005ea6; }
    #profile-modal { text-align: center; background: #f1f1f1; padding: 1rem; margin: 1rem auto; width: 80%; border-radius: 8px; }
  </style>
</head>
<body>
  <!-- Auth UI -->
  <div class="signup-section" id="signup-section">
    <h2>Create an Account</h2>
    <input type="email" id="signup-email" placeholder="Email" required />
    <input type="password" id="signup-password" placeholder="Password" required />
    <button class="auth-btn" id="signup-btn">Sign Up</button>
    <h2>or Login</h2>
    <input type="email" id="login-email" placeholder="Email" required />
    <input type="password" id="login-password" placeholder="Password" required />
    <button class="auth-btn" id="login-btn">Login</button>
    <button class="auth-btn" id="logout-btn" style="display:none;">Logout</button>
    <p id="auth-message"></p>
  </div>

  <!-- Profile Completion Modal -->
  <div id="profile-modal" style="display:none;">
    <h3>Complete Your Profile</h3>
    <input type="text" id="profile-name" placeholder="Full Name" required />
    <input type="tel" id="profile-phone" placeholder="Phone" required />
    <button class="auth-btn" id="save-profile-btn">Save</button>
  </div>

  <!-- Add Listing Form -->
  <form id="add-listing-form" style="display:none;" enctype="multipart/form-data">
    <h2>Add a Rental Listing</h2>
    <input type="text" id="make" placeholder="Make" required />
    <input type="text" id="model" placeholder="Model" required />
    <input type="number" id="year" placeholder="Year" min="2000" max="2026" required />
    <input type="number" id="daily-rate" placeholder="Daily Rate $" min="1" required />
    <input type="number" id="weekly-rate" placeholder="Weekly Rate $" />
    <input type="number" id="monthly-rate" placeholder="Monthly Rate $" />
    <input type="number" id="minimum-rental-days" placeholder="Minimum Rental Days" min="1" required />
    <input type="date" id="available-from" placeholder="Available From" required />
    <input type="date" id="available-to" placeholder="Available To" />
    <input type="number" id="included-mileage" placeholder="Included Mileage" />
    <input type="number" id="excess-mileage-fee" placeholder="Excess Mileage Fee" />
    <input type="text" id="location" placeholder="Location" required />
    <label for="tlc-inspection">TLC Inspection</label>
    <select id="tlc-inspection" required>
      <option value="">Select...</option>
      <option value="true">Valid</option>
      <option value="false">Expired</option>
    </select>
    <textarea id="description" placeholder="Additional Details or Description..."></textarea>
    <select id="contact-method">
      <option value="profile">Use Profile Contact</option>
      <option value="custom">Custom Contact Info</option>
    </select>
    <input type="file" id="image-upload" accept="image/*" multiple required />
    <div class="g-recaptcha" data-sitekey="6LeRrGwrAAAAAHOf1H2c-iWsTfzwTbGkgF6qifXY"></div>
    <button class="submit-btn" type="submit">Submit Listing</button>
  </form>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
  // Initialize Supabase
  const SUPABASE_URL = "https://dndeljolayctbafmizcl.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRuZGVsam9sYXljdGJhZm1pemNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4NjIxMDUsImV4cCI6MjA2NTQzODEwNX0.OiK-9-BN0NdgSF1ROmEepANA8ZMJ7kMipCpR8xJSA2w";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  
  // Common headers for Supabase requests
  const headers = {
    'apikey': SUPABASE_KEY,
    'Authorization': `Bearer ${SUPABASE_KEY}`,
    'Content-Type': 'application/json',
    'Prefer': 'return=minimal'
  };

  async function checkSessionAndLoadUI() {
    try {
      const { data: { session }, error } = await supabase.auth.getSession();
      if (error) throw error;
      
      const user = session?.user;
      if (user) {
        document.getElementById("logout-btn").style.display = "inline-block";
        document.getElementById("auth-message").textContent = `Welcome, ${user.email}`;

        // Check if profile exists
        const { data: profile, error: profileError } = await supabase
          .from("profiles")
          .select("*")
          .eq("id", user.id)
          .single();

        if (profileError || !profile || !profile.full_name || !profile.phone) {
          document.getElementById("profile-modal").style.display = "block";
          // Pre-fill email if available
          if (user.email) {
            document.getElementById("profile-email").value = user.email;
          }
        } else {
          document.getElementById("add-listing-form").style.display = "block";
        }
      }
    } catch (error) {
      console.error("Session check error:", error);
    }
  }

  // Signup handler
  document.getElementById("signup-btn").onclick = async () => {
    try {
      const email = document.getElementById("signup-email").value.trim();
      const password = document.getElementById("signup-password").value.trim();
      
      const { data, error } = await supabase.auth.signUp({ 
        email, 
        password,
        options: {
          data: {
            full_name: '',
            phone: ''
          }
        }
      });
      
      if (error) throw error;
      
      alert("Signup successful. Please check your email to confirm.");
    } catch (error) {
      alert("Signup failed: " + error.message);
    }
  };

  // Login handler
  document.getElementById("login-btn").onclick = async () => {
    try {
      const email = document.getElementById("login-email").value.trim();
      const password = document.getElementById("login-password").value.trim();
      
      const { data, error } = await supabase.auth.signInWithPassword({ 
        email, 
        password 
      });
      
      if (error) throw error;
      location.reload();
    } catch (error) {
      alert("Login failed: " + error.message);
    }
  };

  // Profile completion handler
  document.getElementById("save-profile-btn").onclick = async () => {
    try {
      const fullName = document.getElementById("profile-name").value.trim();
      const phone = document.getElementById("profile-phone").value.trim();
      
      if (!fullName || !phone) {
        throw new Error("All fields are required");
      }
      
      const { data: { user }, error } = await supabase.auth.getUser();
      if (error) throw error;
      
      const { error: updateError } = await supabase
        .from("profiles")
        .upsert({ 
          id: user.id, 
          full_name: fullName, 
          phone,
          updated_at: new Date().toISOString()
        });
        
      if (updateError) throw updateError;
      
      document.getElementById("profile-modal").style.display = "none";
      document.getElementById("add-listing-form").style.display = "block";
    } catch (error) {
      alert("Error saving profile: " + error.message);
    }
  };

  // Listing submission handler
  document.getElementById("add-listing-form").onsubmit = async (e) => {
    e.preventDefault();
    
    try {
      const recaptchaResponse = grecaptcha.getResponse();
      if (!recaptchaResponse) throw new Error("Please complete the reCAPTCHA.");

      const files = document.getElementById("image-upload").files;
      if (files.length === 0) throw new Error("Please upload at least one image.");
      if (files.length > 20) throw new Error("Maximum 20 images allowed.");

      // Upload images
      const imageUrls = await Promise.all([...files].map(async (file) => {
        const fileName = `rentals/${Date.now()}-${file.name}`;
        const { error } = await supabase.storage.from("vehicle-images").upload(fileName, file);
        if (error) throw error;
        return `${SUPABASE_URL}/storage/v1/object/public/vehicle-images/${fileName}`;
      }));

      // Get current user
      const { data: { user }, error: userError } = await supabase.auth.getUser();
      if (userError) throw userError;

      // Verify profile exists
      const { data: profile, error: profileError } = await supabase
        .from("profiles")
        .select("*")
        .eq("id", user.id)
        .single();
        
      if (profileError || !profile) {
        throw new Error("You must complete your profile before submitting a listing.");
      }

      // Prepare listing data
      const listing = {
        make: document.getElementById("make").value,
        model: document.getElementById("model").value,
        year: +document.getElementById("year").value,
        daily_rate: +document.getElementById("daily-rate").value,
        weekly_rate: document.getElementById("weekly-rate").value ? +document.getElementById("weekly-rate").value : null,
        monthly_rate: document.getElementById("monthly-rate").value ? +document.getElementById("monthly-rate").value : null,
        minimum_rental_days: +document.getElementById("minimum-rental-days").value,
        available_from: document.getElementById("available-from").value,
        available_to: document.getElementById("available-to").value || null,
        included_mileage: document.getElementById("included-mileage").value ? +document.getElementById("included-mileage").value : 100,
        excess_mileage_fee: document.getElementById("excess-mileage-fee").value ? +document.getElementById("excess-mileage-fee").value : 50,
        location: document.getElementById("location").value,
        tlc_inspection: document.getElementById("tlc-inspection").value === "true",
        description: document.getElementById("description").value,
        contact_method: document.getElementById("contact-method").value || "profile",
        photos: imageUrls,
        owner_id: user.id,
        status: "active",
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      };

      // Insert listing
      const { error: insertError } = await supabase.from("rental_listings").insert([listing]);
      if (insertError) throw insertError;

      alert("Listing submitted successfully!");
      location.href = "thank-you.html";
    } catch (error) {
      alert("Error submitting listing: " + error.message);
      console.error("Listing submission error:", error);
    }
  };

  // Initial UI check
  await checkSessionAndLoadUI();
});
  </script>
</body>
</html>



