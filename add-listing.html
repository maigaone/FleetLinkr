<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FleetLinkr - Add Listing</title>
  <link rel="stylesheet" href="assets/css/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <style>
    .add-listing-container { max-width: 800px; margin: 2rem auto; padding: 2rem; background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .add-listing-form { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    .form-group { margin-bottom: 1rem; }
    .form-group.full-width { grid-column: span 2; }
    label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333; }
    input, textarea, select { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; }
    textarea { min-height: 120px; resize: vertical; }
    .file-upload { border: 2px dashed #ddd; padding: 2rem; text-align: center; border-radius: 4px; cursor: pointer; }
    .file-upload:hover { border-color: #0074D9; }
    .submit-btn { grid-column: span 2; background: #0074D9; color: white; padding: 1rem; border: none; border-radius: 4px; font-size: 1.1rem; cursor: pointer; transition: background 0.3s; }
    .submit-btn:hover { background: #005ea6; }
    h1 { color: #0074D9; margin-bottom: 2rem; text-align: center; }
    .g-recaptcha { grid-column: span 2; margin: 1rem 0; display: flex; justify-content: center; }
    .auth-section, .signup-section { text-align: center; padding: 1rem; background: #f8f9fa; margin-bottom: 1rem; }
    .auth-btn { background: #0074D9; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; margin: 0.5rem; }
    .auth-btn:hover { background: #005ea6; }
    #profile-modal { text-align: center; background: #f1f1f1; padding: 1rem; margin: 1rem auto; width: 80%; border-radius: 8px; }
  </style>
</head>
<body>
  <!-- Auth UI -->
  <div class="signup-section" id="signup-section">
    <h2>Create an Account</h2>
    <input type="email" id="signup-email" placeholder="Email" required />
    <input type="password" id="signup-password" placeholder="Password" required />
    <button class="auth-btn" id="signup-btn">Sign Up</button>
    <h2>or Login</h2>
    <input type="email" id="login-email" placeholder="Email" required />
    <input type="password" id="login-password" placeholder="Password" required />
    <button class="auth-btn" id="login-btn">Login</button>
    <button class="auth-btn" id="logout-btn" style="display:none;">Logout</button>
    <p id="auth-message"></p>
  </div>

  <!-- Profile Completion Modal -->
  <div id="profile-modal" style="display:none;">
    <h3>Complete Your Profile</h3>
    <input type="text" id="profile-name" placeholder="Full Name" required />
    <input type="tel" id="profile-phone" placeholder="Phone" required />
    <button class="auth-btn" id="save-profile-btn">Save</button>
  </div>

  <!-- Add Listing Form -->
  <form id="add-listing-form" style="display:none;" enctype="multipart/form-data">
    <h2>Add a Rental Listing</h2>
    <input type="text" id="make" placeholder="Make" required />
    <input type="text" id="model" placeholder="Model" required />
    <input type="number" id="year" placeholder="Year" min="2000" max="2026" required />
    <input type="number" id="daily-rate" placeholder="Daily Rate $" min="1" required />
    <input type="number" id="weekly-rate" placeholder="Weekly Rate $" />
    <input type="number" id="monthly-rate" placeholder="Monthly Rate $" />
    <input type="number" id="minimum-rental-days" placeholder="Minimum Rental Days" min="1" required />
    <input type="date" id="available-from" placeholder="Available From" required />
    <input type="date" id="available-to" placeholder="Available To" />
    <input type="number" id="included-mileage" placeholder="Included Mileage" />
    <input type="number" id="excess-mileage-fee" placeholder="Excess Mileage Fee" />
    <input type="text" id="location" placeholder="Location" required />
    <label for="tlc-inspection">TLC Inspection</label>
    <select id="tlc-inspection" required>
      <option value="">Select...</option>
      <option value="true">Valid</option>
      <option value="false">Expired</option>
    </select>
    <textarea id="description" placeholder="Additional Details or Description..."></textarea>
    <select id="contact-method">
      <option value="profile">Use Profile Contact</option>
      <option value="custom">Custom Contact Info</option>
    </select>
    <input type="file" id="image-upload" accept="image/*" multiple required />
    <div class="g-recaptcha" data-sitekey="6LeRrGwrAAAAAHOf1H2c-iWsTfzwTbGkgF6qifXY"></div>
    <button class="submit-btn" type="submit">Submit Listing</button>
  </form>

  <script>
    const SUPABASE_URL = "https://dndeljolayctbafmizcl.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRuZGVsam9sYXljdGJhZm1pemNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4NjIxMDUsImV4cCI6MjA2NTQzODEwNX0.OiK-9-BN0NdgSF1ROmEepANA8ZMJ7kMipCpR8xJSA2w";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function checkSessionAndLoadUI() {
      const { data: { session } } = await supabase.auth.getSession();
      const user = session?.user;

      if (user) {
        document.getElementById("logout-btn").style.display = "inline-block";
        document.getElementById("auth-message").textContent = `Welcome, ${user.email}`;

        const { data: profile } = await supabase.from("profiles").select("*").eq("id", user.id).single();

        if (!profile || !profile.full_name || !profile.phone) {
          document.getElementById("profile-modal").style.display = "block";
        } else {
          document.getElementById("add-listing-form").style.display = "block";
        }
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await checkSessionAndLoadUI();
     document.getElementById("signup-btn").onclick = async () => {
        const email = document.getElementById("signup-email").value.trim();
        const password = document.getElementById("signup-password").value.trim();
        const { data, error } = await supabase.auth.signUp({ email, password });
        if (error) return alert("Signup failed: " + error.message);

        const userId = data.user?.id;
        if (userId) {
          await supabase.from("profiles").upsert({ id: userId, email, full_name: '', phone: '', role: 'user' });
        }

        alert("Signup successful. Please check your email to confirm.");
      };

     document.getElementById("login-btn").onclick = async () => {
        const email = document.getElementById("login-email").value.trim();
        const password = document.getElementById("login-password").value.trim();
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) return alert("Login failed: " + error.message);

        const userId = data.user?.id;
        if (userId) {
          await supabase.from("profiles").upsert({ id: userId, email, full_name: '', phone: '', role: 'user' });
        }

        location.reload();
      };


      document.getElementById("save-profile-btn").onclick = async () => {
        const fullName = document.getElementById("profile-name").value.trim();
        const phone = document.getElementById("profile-phone").value.trim();
        if (!fullName || !phone) return alert("All fields are required");
        const userId = (await supabase.auth.getUser()).data.user.id;
        await supabase.from("profiles").upsert({ id: userId, full_name: fullName, phone, updated_at: new Date().toISOString() });
        document.getElementById("profile-modal").style.display = "none";
        document.getElementById("add-listing-form").style.display = "block";
      };

      <!-- Truncated for brevity -->

      document.getElementById("add-listing-form").onsubmit = async (e) => {
        e.preventDefault();
        const recaptchaResponse = grecaptcha.getResponse();
        if (!recaptchaResponse) return alert("Please complete the reCAPTCHA.");

        const files = document.getElementById("image-upload").files;
        if (files.length === 0) return alert("Please upload at least one image.");
        if (files.length > 20) return alert("Maximum 20 images allowed.");

        const imageUrls = await Promise.all([...files].map(async (file) => {
          const fileName = `rentals/${Date.now()}-${file.name}`;
          const { error } = await supabase.storage.from("vehicle-images").upload(fileName, file);
          if (error) throw error;
          return `${SUPABASE_URL}/storage/v1/object/public/vehicle-images/${fileName}`;
        }));

        const userId = (await supabase.auth.getUser()).data.user.id;

        // âœ… Ensure user profile exists before inserting listing
        const { data: profileCheck, error: profileError } = await supabase
          .from("profiles")
          .select("id")
          .eq("id", userId)
          .single();

        if (profileError || !profileCheck) {
          alert("You must complete your profile before submitting a listing.");
          return;
        }

        const listing = {
          make: document.getElementById("make").value,
          model: document.getElementById("model").value,
          year: +document.getElementById("year").value,
          daily_rate: +document.getElementById("daily-rate").value,
          weekly_rate: +document.getElementById("weekly-rate").value || null,
          monthly_rate: +document.getElementById("monthly-rate").value || null,
          minimum_rental_days: +document.getElementById("minimum-rental-days").value,
          available_from: document.getElementById("available-from").value,
          available_to: document.getElementById("available-to").value || null,
          included_mileage: +document.getElementById("included-mileage").value || 100,
          excess_mileage_fee: +document.getElementById("excess-mileage-fee").value || 50,
          location: document.getElementById("location").value,
          tlc_inspection: document.getElementById("tlc-inspection").value === "true",
          description: document.getElementById("description").value,
          contact_method: document.getElementById("contact-method").value || "profile",
          photos: imageUrls,
          owner_id: userId,
          status: "active",
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        };

        const { error } = await supabase.from("rental_listings").insert([listing]);
        if (error) return alert("Failed to submit listing: " + error.message);

        alert("Listing submitted!");
        location.href = "thank-you.html";
      };

    });
  </script>
</body>
</html>



